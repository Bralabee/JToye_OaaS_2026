# Phase 1 Implementation Plan - Domain Enrichment

**Branch:** `phase-1/domain-enrichment`
**Started:** December 28, 2025
**Status:** ðŸ”„ In Progress

---

## Overview

Phase 1 focuses on enriching the domain model with core business entities and capabilities while maintaining backward compatibility with Phase 0/1's multi-tenant foundation.

---

## Implementation Strategy

### Principles
1. **Incremental Development**: Build one feature at a time with validation
2. **Test-Driven**: Write tests before or alongside implementation
3. **Backward Compatibility**: No breaking changes to existing APIs
4. **Multi-tenant First**: All new entities must respect tenant isolation
5. **Documentation**: Update docs as we build

### Validation at Each Step
- âœ… Run existing tests to ensure no regression
- âœ… Add new tests for new features
- âœ… Verify RLS policies on new tables
- âœ… Test multi-tenant isolation
- âœ… Update documentation

---

## Phase 1 Objectives (Prioritized)

### 1. Envers Auditing (Week 1) ðŸŽ¯ HIGH PRIORITY
**Goal**: Track all changes to entities for compliance and debugging

**Tasks**:
- [ ] Add Envers dependencies to build.gradle.kts
- [ ] Configure Envers in application.yml
- [ ] Enable auditing on existing entities (Shop, Product)
- [ ] Create audit tables migration (V5__audit_tables.sql)
- [ ] Add AuditReader utility service
- [ ] Write tests for audit functionality
- [ ] Update documentation

**Acceptance Criteria**:
- All entity changes are tracked in `*_aud` tables
- Audit records include tenant_id for isolation
- Can retrieve entity history via AuditReader
- No performance degradation (audit writes are async if possible)

**Risks**: Minimal - Envers is non-invasive

---

### 2. Order Entity & Basic CRUD (Week 1-2) ðŸŽ¯ HIGH PRIORITY
**Goal**: Create order entity with basic management capabilities

**Tasks**:
- [ ] Design Order entity with proper relationships
- [ ] Create Order, OrderItem domain models
- [ ] Create database migration (V6__orders.sql)
- [ ] Apply RLS policies to order tables
- [ ] Implement OrderRepository
- [ ] Create Order DTOs (CreateOrderRequest, OrderResponse)
- [ ] Implement OrderController with CRUD endpoints
- [ ] Write integration tests for orders
- [ ] Verify multi-tenant isolation

**Acceptance Criteria**:
- Can create orders with items
- Orders are tenant-scoped (RLS enforced)
- CRUD operations work correctly
- Existing tests still pass
- Integration tests cover tenant isolation

**Risks**: Medium - Complex relationships, need careful RLS setup

---

### 3. State Machine for Orders (Week 2) ðŸŽ¯ MEDIUM PRIORITY
**Goal**: Implement order workflow with state transitions

**Tasks**:
- [ ] Review Spring State Machine documentation
- [ ] Design order states (DRAFT, PENDING, CONFIRMED, PREPARING, READY, COMPLETED, CANCELLED)
- [ ] Design state transitions and events
- [ ] Configure Spring State Machine
- [ ] Implement state transition endpoints
- [ ] Add state validation guards
- [ ] Write state machine tests
- [ ] Update Order entity with state field

**Acceptance Criteria**:
- Orders progress through defined states
- Invalid transitions are rejected
- State changes are audited (via Envers)
- Tests cover all valid and invalid transitions

**Risks**: High - State machines can be complex, need careful design

---

### 4. Customer Entity (Week 2-3) ðŸŽ¯ MEDIUM PRIORITY
**Goal**: Add customer management capabilities

**Tasks**:
- [ ] Design Customer entity
- [ ] Create database migration (V7__customers.sql)
- [ ] Apply RLS policies to customers table
- [ ] Link customers to orders (foreign key)
- [ ] Implement CustomerRepository
- [ ] Create Customer DTOs and controller
- [ ] Write integration tests
- [ ] Update order creation to require customer

**Acceptance Criteria**:
- Customers are tenant-scoped
- Can link customers to orders
- CRUD operations work correctly
- Existing functionality not broken

**Risks**: Low - Straightforward entity addition

---

### 5. JasperReports Integration (Week 3-4) ðŸŽ¯ LOW PRIORITY
**Goal**: Generate PDF reports/labels for products and orders

**Tasks**:
- [ ] Add JasperReports dependencies
- [ ] Create product label template (.jrxml)
- [ ] Create order invoice template
- [ ] Implement ReportService
- [ ] Add report generation endpoints
- [ ] Write tests for report generation
- [ ] Document report templates

**Acceptance Criteria**:
- Can generate product labels as PDF
- Can generate order invoices
- Reports respect tenant data isolation
- Templates are customizable

**Risks**: Medium - JasperReports has learning curve

---

## Database Migrations Plan

### V5__audit_tables.sql
```sql
-- Envers audit tables for shops, products
-- These are auto-generated by Envers but we'll create explicit migration
```

### V6__orders.sql
```sql
-- orders table with tenant_id, customer_id, status
-- order_items table with order_id, product_id, quantity, price
-- RLS policies for both tables
```

### V7__customers.sql
```sql
-- customers table with tenant_id, name, email, phone, address
-- RLS policies
-- Add customer_id FK to orders table
```

---

## Testing Strategy

### Regression Testing
Before each commit, run:
```bash
cd core-java
../gradlew test
```
**Expected**: All 11 existing tests must pass

### New Tests (Target: +15 tests)
- **AuditingTest**: 3 tests (shop audit, product audit, history retrieval)
- **OrderControllerIntegrationTest**: 6 tests (CRUD, tenant isolation)
- **StateMachineTest**: 4 tests (valid transitions, invalid transitions, guards)
- **CustomerControllerIntegrationTest**: 3 tests (CRUD, order linking)
- **ReportServiceTest**: 2 tests (product label, order invoice)

**Target**: 26 total tests passing by end of Phase 1

---

## Risk Mitigation

### Breaking Changes Prevention
1. **API Versioning**: Keep v1 endpoints unchanged
2. **Database**: Only additive changes (new tables/columns)
3. **Backward Compatibility**: Existing shops/products APIs unchanged
4. **Feature Flags**: Use @ConditionalOnProperty if needed

### Performance Monitoring
1. Test suite should complete in < 3 seconds
2. API response times < 200ms
3. Database queries optimized (use EXPLAIN)

### Security Validation
1. All new tables MUST have RLS policies
2. All new endpoints MUST require JWT
3. Tenant isolation MUST be tested
4. No cross-tenant data leakage

---

## Implementation Order (Step-by-Step)

### Step 1: Envers Setup (2-3 hours)
1. Add dependencies
2. Configure Envers
3. Annotate existing entities
4. Run migration
5. Test audit functionality
6. âœ… Verify: Existing tests pass + 3 new audit tests pass

### Step 2: Order Entity (4-6 hours)
1. Create Order domain model
2. Create migration V6
3. Apply RLS policies
4. Implement repository
5. Create DTOs and controller
6. Write integration tests
7. âœ… Verify: All tests pass, orders are tenant-isolated

### Step 3: State Machine (6-8 hours)
1. Design state diagram
2. Configure Spring State Machine
3. Implement transition logic
4. Add endpoints for transitions
5. Write state machine tests
6. âœ… Verify: All tests pass, transitions work correctly

### Step 4: Customer Entity (3-4 hours)
1. Create Customer domain model
2. Create migration V7
3. Apply RLS policies
4. Link to orders
5. Implement CRUD
6. Write tests
7. âœ… Verify: All tests pass, customers linked to orders

### Step 5: JasperReports (4-6 hours)
1. Add dependencies
2. Create templates
3. Implement report service
4. Add endpoints
5. Write tests
6. âœ… Verify: Reports generate correctly

---

## Success Metrics

### Code Quality
- [ ] All tests passing (target: 26 tests)
- [ ] Test coverage > 80%
- [ ] No compiler warnings
- [ ] Code follows existing patterns

### Security
- [ ] RLS policies on all new tables
- [ ] Tenant isolation verified for all new features
- [ ] JWT authentication on all new endpoints
- [ ] No security vulnerabilities

### Performance
- [ ] Test suite < 3 seconds
- [ ] API endpoints < 200ms response time
- [ ] No N+1 query problems

### Documentation
- [ ] README.md updated with new features
- [ ] API endpoints documented
- [ ] Migration guide created
- [ ] CHANGELOG.md updated

---

## Rollback Plan

If issues arise:
1. Revert to master branch: `git checkout master`
2. Database rollback: Drop new tables, restore from V4 state
3. Document lessons learned
4. Create hotfix if needed

---

## Daily Checklist

At end of each implementation session:
- [ ] Run full test suite
- [ ] Check git status (no uncommitted changes left)
- [ ] Update this plan with progress
- [ ] Commit work with clear message
- [ ] Push to remote (if applicable)

---

## Progress Tracking

### Day 1 (2025-12-28)
- [x] Created phase-1/domain-enrichment branch
- [x] Created implementation plan
- [ ] Start Envers implementation

### Day 2
- [ ] TBD

---

## Notes & Decisions

### Decision Log
1. **Order States**: Using Spring State Machine instead of simple enum for flexibility
2. **Audit Tables**: Letting Envers auto-generate, with migration to document structure
3. **Customer First**: Building customer entity before complex order features
4. **JasperReports Last**: Lower priority, can be deferred if time constrained

### Questions to Resolve
- [ ] Should orders have draft state or always start as PENDING?
- [ ] Do we need order cancellation workflow?
- [ ] What customer fields are required vs optional?
- [ ] Should reports be generated synchronously or async?

---

**Last Updated**: 2025-12-28
**Current Task**: Setting up Envers auditing
